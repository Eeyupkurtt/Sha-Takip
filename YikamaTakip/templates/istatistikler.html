{% extends "layout.html" %}
{% block title %}İstatistikler{% endblock %}

{% block content %}
<style>
    .filtre-container {
        display: flex; gap: 20px; margin-bottom: 20px;
        background-color: var(--bg-light); padding: 15px;
        border-radius: 6px; border: 1px solid var(--border-color);
        align-items: flex-end;
    }
    .filtre-grup { flex: 1; }
    .yikamaci-renk {
        display: inline-block; width: 12px; height: 12px;
        border-radius: 50%; margin-right: 6px; border: 1px solid #999;
        vertical-align: middle;
    }
    .rapor-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: flex-start;
    }
    .panel-full { grid-column: 1 / -1; }

    .arama-container {
        position: relative; 
        margin-bottom: 15px;
    }
    .arama-container input {
        width: 100%;
        padding: 12px;
        font-size: 1.1em;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }
    #tedarikci-custom-list {
        display: none; 
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-white);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 8px 12px rgba(0,0,0,0.1);
    }
    .dropdown-option {
        padding: 12px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .dropdown-option:hover {
        background-color: #f0f0f0;
    }
    .dropdown-option:not(:last-child) {
        border-bottom: 1px solid #f5f5f5;
    }
    
    #tedarikci-detay-tablosu td:nth-child(4) {
        max-width: 300px;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 0.9em;
        color: #555;
    }
    
    .tablo-scroll-wrapper {
        max-height: 400px; 
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }
    
    .detay-filtre-container {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        background-color: #fdfdfd;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        margin-bottom: 15px;
    }
    .detay-filtre-container .filtre-grup {
        flex: 1;
    }
    .detay-filtre-container label {
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 5px;
        display: block;
    }
</style>

<div class="panel">
    <h2>İstatistik Raporları</h2>
    
    <div class="filtre-container">
        <div class="filtre-grup">
            <label for="tarih-baslangic-ana">Başlangıç Tarihi (Ana Raporlar):</label>
            <input type="date" id="tarih-baslangic-ana">
        </div>
        <div class="filtre-grup">
            <label for="tarih-bitis-ana">Bitiş Tarihi (Ana Raporlar):</label>
            <input type="date" id="tarih-bitis-ana">
        </div>
        <button id="rapor-yenile-btn">Ana Raporları Filtrele</button>
    </div>
    
    <div class="rapor-grid">
        <div class="panel">
            <h3>Yıkamacı İstatistikleri</h3>
            <div class="tablo-scroll-wrapper">
                <table id="yikamaci-stats-tablo">
                    <thead><tr><th>Yıkamacı</th><th>Toplam Yıkama</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="panel">
            <h3>Tedarikçi İstatistikleri</h3>
            <div class="tablo-scroll-wrapper">
                <table id="tedarikci-stats-tablo">
                    <thead><tr><th>Tedarikçi</th><th>Toplam Yıkama</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div class="panel panel-full">
            <h3>Tedarikçi Detaylı Dökümü</h3>
            
            <div class="detay-filtre-container">
                <div class="filtre-grup">
                    <label for="tarih-baslangic-detay">Başlangıç Tarihi (Detay):</label>
                    <input type="date" id="tarih-baslangic-detay">
                </div>
                <div class="filtre-grup">
                    <label for="tarih-bitis-detay">Bitiş Tarihi (Detay):</label>
                    <input type="date" id="tarih-bitis-detay">
                </div>
            </div>

            <div class="arama-container">
                <label for="tedarikci-arama" style="font-weight: 600;">Tedarikçi Adına Göre Ara:</label>
                <input type="text" id="tedarikci-arama" placeholder="Tedarikçi seçin veya yazın..." autocomplete="off">
                <div id="tedarikci-custom-list"></div>
            </div>

            <div class="tablo-scroll-wrapper">
                <table id="tedarikci-detay-tablosu">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Plaka</th>
                            <th>Yıkamacı</th>
                            <th>Not</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4">Lütfen arama yapın.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-full">
            <h3>Detaylı Döküm (Tedarikçi-Yıkamacı)</h3>
            <div class="tablo-scroll-wrapper">
                <table id="detayli-stats-tablo">
                    <thead><tr><th>Tedarikçi</th><th>Yıkamacı</th><th>Toplam</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Ana raporlar
    const tarihBaslangicAna = document.getElementById('tarih-baslangic-ana');
    const tarihBitisAna = document.getElementById('tarih-bitis-ana');
    const yenileBtn = document.getElementById('rapor-yenile-btn');

    const yikamaciTablo = document.getElementById('yikamaci-stats-tablo').tBodies[0];
    const tedarikciTablo = document.getElementById('tedarikci-stats-tablo').tBodies[0];
    const detayliTablo = document.getElementById('detayli-stats-tablo').tBodies[0];

    // Detaylı Arama Raporu
    const tarihBaslangicDetay = document.getElementById('tarih-baslangic-detay');
    const tarihBitisDetay = document.getElementById('tarih-bitis-detay');
    const tedarikciAramaInput = document.getElementById('tedarikci-arama');
    const tedarikciCustomList = document.getElementById('tedarikci-custom-list');
    const tedarikciDetayTablo = document.getElementById('tedarikci-detay-tablosu').tBodies[0];
    
    let globalTedarikciler = [];

    // Ana raporları yükler
    async function anaRaporlariYukle() {
        yikamaciTablo.innerHTML = '<tr><td colspan="2">Yükleniyor...</td></tr>';
        tedarikciTablo.innerHTML = '<tr><td colspan="2">Yükleniyor...</td></tr>';
        detayliTablo.innerHTML = '<tr><td colspan="3">Yükleniyor...</td></tr>';

        const params = new URLSearchParams();
        if (tarihBaslangicAna.value && tarihBitisAna.value) {
            params.append('tarih_baslangic', tarihBaslangicAna.value);
            params.append('tarih_bitis', tarihBitisAna.value);
        }
        
        const response = await fetch(`/api/istatistikler?${params.toString()}`, { cache: 'no-store' });
        const data = await response.json();

        // yıkamacı tablosu
        yikamaciTablo.innerHTML = '';
        data.yikamaci_stats.forEach(r => {
            yikamaciTablo.innerHTML += `
                <tr>
                    <td><span class="yikamaci-renk" style="background-color:${r.renk};"></span>${r.ad}</td>
                    <td>${r.toplam_yikama}</td>
                </tr>`;
        });

        //tedarikçi tablosu
        tedarikciTablo.innerHTML = '';
        data.tedarikci_stats.forEach(r => {
            tedarikciTablo.innerHTML += `
                <tr>
                    <td>${r.ad}</td>
                    <td>${r.toplam_yikama}</td>
                </tr>`;
        });

        // detaylı tablo 
        detayliTablo.innerHTML = '';
        data.detayli_stats.forEach(r => {
            detayliTablo.innerHTML += `
                <tr>
                    <td>${r.tedarikci_adi}</td>
                    <td>
                        <span class="yikamaci-renk" style="background-color:${r.yikamaci_rengi};"></span>
                        ${r.yikamaci_adi}
                    </td>
                    <td>${r.toplam_yikama}</td>
                </tr>`;
        });
    }

    // Tedarikçi arama raporunu yükler
    async function tedarikciDetayYukle() {
        const aramaTerimi = tedarikciAramaInput.value.trim();

        if (!aramaTerimi) {
            tedarikciDetayTablo.innerHTML = '<tr><td colspan="4">Lütfen arama yapın.</td></tr>';
            return;
        }

        tedarikciDetayTablo.innerHTML = '<tr><td colspan="4">Yükleniyor...</td></tr>';
        
        const params = new URLSearchParams();
        params.append('tedarikci_ad', aramaTerimi);
        
        if (tarihBaslangicDetay.value && tarihBitisDetay.value) {
            params.append('tarih_baslangic_detay', tarihBaslangicDetay.value);
            params.append('tarih_bitis_detay', tarihBitisDetay.value);
        }
        
        try {
            const response = await fetch(`/api/tedarikci_detayli_rapor?${params.toString()}`, { cache: 'no-store' });
            const kayitlar = await response.json();
            
            tedarikciDetayTablo.innerHTML = '';
            if (kayitlar.length === 0) {
                tedarikciDetayTablo.innerHTML = '<tr><td colspan="4">Bu tedarikçi için kayıt bulunamadı.</td></tr>';
                return;
            }

            kayitlar.forEach(k => {
                tedarikciDetayTablo.innerHTML += `
                    <tr>
                        <td>${k.tarih}</td>
                        <td>${k.plaka_no}</td>
                        <td>
                            <span class="yikamaci-renk" style="background-color:${k.yikamaci_rengi};"></span>
                            ${k.yikamaci_adi}
                        </td>
                        <td>${k.not || '-'}</td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Tedarikçi detay raporu hatası:', error);
            tedarikciDetayTablo.innerHTML = '<tr><td colspan="4">Rapor yüklenirken hata oluştu.</td></tr>';
        }
    }

    // Tedarikçi listesini global değişkene yükler
    async function tedarikciListesiYukle() {
        try {
            const response = await fetch('/api/tedarikciler', { cache: 'no-store' });
            globalTedarikciler = await response.json();
        } catch (error) {
            console.error('Tedarikçi listesi yüklenemedi:', error);
        }
    }
    
    // Özel açılır listeyi filtreler ve çizer
    function renderCustomDropdown(filter = '') {
        const filterText = filter.toLowerCase();
        const filteredList = globalTedarikciler.filter(t => 
            t.ad.toLowerCase().includes(filterText)
        );
        
        if (filteredList.length === 0) {
            tedarikciCustomList.style.display = 'none';
            return;
        }
        
        tedarikciCustomList.innerHTML = '';
        filteredList.forEach(t => {
            tedarikciCustomList.innerHTML += 
                `<div class="dropdown-option" data-value="${t.ad}">${t.ad}</div>`;
        });
        tedarikciCustomList.style.display = 'block';
    }

    //Olay Dinleyicileri

    yenileBtn.addEventListener('click', anaRaporlariYukle);

    tedarikciAramaInput.addEventListener('focus', () => {
        renderCustomDropdown(tedarikciAramaInput.value);
    });

    tedarikciAramaInput.addEventListener('input', () => {
        renderCustomDropdown(tedarikciAramaInput.value);
    });

    tedarikciAramaInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            tedarikciDetayYukle();
            tedarikciCustomList.style.display = 'none';
        }
    });

    tedarikciAramaInput.addEventListener('blur', () => {
        setTimeout(() => {
            tedarikciCustomList.style.display = 'none';
        }, 150); 
    });
    
    tedarikciCustomList.addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-option')) {
            const secilenDeger = e.target.dataset.value;
            tedarikciAramaInput.value = secilenDeger; 
            tedarikciCustomList.style.display = 'none'; 
            tedarikciDetayYukle(); 
        }
    });
    
    tarihBaslangicDetay.addEventListener('change', tedarikciDetayYukle);
    tarihBitisDetay.addEventListener('change', tedarikciDetayYukle);


    function setDefaultDates() {
        const today = new Date();
        const priorDate = new Date(new Date().setDate(today.getDate() - 30));
        
        tarihBitisAna.valueAsDate = today;
        tarihBaslangicAna.valueAsDate = priorDate;
        
        tarihBitisDetay.valueAsDate = today;
        tarihBaslangicDetay.valueAsDate = priorDate;
    }

    setDefaultDates();
    anaRaporlariYukle();
    tedarikciListesiYukle();
});
</script>
{% endblock %}